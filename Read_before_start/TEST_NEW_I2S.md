# 新I2S API测试指南 🧪

## 测试目的
验证使用新I2S API重写后的麦克风功能是否正常工作，以及与TTS播放是否存在冲突。

---

## 📋 测试前检查

### 1. 硬件连接确认

**麦克风 (INMP441) 接线:**
```
INMP441          ESP32-S3 CAM
─────────────────────────────
VDD          →   3.3V
GND          →   GND
SD (数据)    →   GPIO 48
WS (LR时钟)  →   GPIO 45
SCK (位时钟) →   GPIO 47
L/R          →   GND (左声道)
```

**扬声器 (MAX98357A) 接线:**
```
MAX98357A        ESP32-S3 CAM
─────────────────────────────
VIN          →   5V
GND          →   GND
DIN (数据)   →   GPIO 41
BCLK (位时钟)→   GPIO 21
LRC (帧时钟) →   GPIO 42
GAIN         →   悬空或GND (9dB增益)
SD           →   悬空或VIN (正常模式)
```

### 2. 配置文件确认

检查 `config_local.h`:
```cpp
// 百度语音识别API
#define BAIDU_ASR_API_KEY "你的API Key"
#define BAIDU_ASR_SECRET_KEY "你的Secret Key"

// 唤醒词
static const char* CUSTOM_WAKE_WORD = "你好小智";

// TTS配置
#define BAIDU_TTS_API_KEY "你的API Key"
#define BAIDU_TTS_SECRET_KEY "你的Secret Key"
```

### 3. 麦克风启用确认

检查 `AI_Answer.ino` 第28行:
```cpp
#define ENABLE_MICROPHONE 1  // ✅ 必须为1
```

---

## 🧪 测试步骤

### 测试1: 系统启动测试

**目标**: 验证系统能正常启动，无I2S冲突

**步骤**:
1. 编译并上传代码到ESP32-S3
2. 打开串口监视器 (115200波特率)
3. 观察启动日志

**预期输出**:
```
✓ 摄像头初始化成功
ℹ️ 麦克风采用按需初始化策略
✓ WiFi连接成功
✓ HTTP服务器启动在端口 80
✅ 系统启动完成！
```

**判断标准**:
- ✅ **通过**: 无 "CONFLICT! The new i2s driver..." 错误
- ✅ **通过**: 无系统重启循环
- ❌ **失败**: 出现I2S冲突错误或重启

---

### 测试2: 麦克风录音测试

**目标**: 验证麦克风能正常录音

**步骤**:
1. 在Web界面点击 "语音分析" 按钮
2. 或短按GPIO 0按钮
3. 对着麦克风说话 (5秒)
4. 观察串口输出

**预期输出**:
```
✓ 麦克风I2S驱动已初始化(新API)
🎤 开始录音 5 秒（目标 160000 字节）...
✓ 录音完成，实际捕获 160000 / 160000 字节
✓ 麦克风I2S驱动已卸载
```

**判断标准**:
- ✅ **通过**: 成功捕获约160000字节音频数据
- ✅ **通过**: 驱动正常初始化和卸载
- ❌ **失败**: 捕获0字节或出现错误
- ⚠️ **警告**: 捕获字节数明显偏少（<100000）可能是麦克风接线问题

---

### 测试3: 语音识别测试

**目标**: 验证录音数据能正确发送到ASR并返回识别结果

**步骤**:
1. 触发语音分析
2. 清晰说出一句话，如 "你好世界"
3. 等待识别结果
4. 观察串口输出

**预期输出**:
```
🎤 开始录音 5 秒...
✓ 录音完成
🎙️ 开始语音识别，音频长度: 160000 字节
发送语音识别请求，大小: XXXXX bytes
语音识别响应码: 200
✓ 识别结果: 你好世界
```

**判断标准**:
- ✅ **通过**: 识别结果与说话内容基本一致
- ⚠️ **警告**: 识别结果为空 → 检查音量、麦克风灵敏度
- ❌ **失败**: HTTP错误或Token错误 → 检查API配置

---

### 测试4: TTS播放测试

**目标**: 验证TTS功能正常工作

**步骤**:
1. 在Web界面点击 "AI分析" 按钮
2. 等待视觉AI分析完成
3. 观察串口和扬声器

**预期输出**:
```
📸 拍照完成
🤖 调用视觉AI...
✓ 视觉分析成功
🔊 [TTS] 开始拉取音频流
♪ 音频开始
♪ 音频结束
✓ 音频播放成功
```

**判断标准**:
- ✅ **通过**: 扬声器播放AI分析结果语音
- ✅ **通过**: 无杂音、卡顿
- ❌ **失败**: 无声音 → 检查扬声器接线
- ⚠️ **警告**: 有杂音 → 检查电源供电

---

### 测试5: 交替使用测试 (关键！)

**目标**: 验证录音和播放交替使用无冲突

**步骤**:
1. 触发语音分析 (录音)
2. 等待完成
3. 触发AI分析 (TTS播放)
4. 等待播放完成
5. 再次触发语音分析 (录音)
6. 重复3-5步骤 5次

**预期结果**:
```
录音 → 成功
TTS  → 成功
录音 → 成功
TTS  → 成功
录音 → 成功
TTS  → 成功
...
```

**判断标准**:
- ✅ **通过**: 所有操作均成功，无错误
- ✅ **通过**: 系统无重启
- ❌ **失败**: 出现I2S冲突或重启

---

### 测试6: 语音唤醒流程测试

**目标**: 验证完整语音唤醒工作流程

**步骤**:
1. 长按GPIO 0按钮 (>2秒) 或Web界面点击"开始语音唤醒"
2. 说出唤醒词 "你好小智"
3. 听到提示音后说出指令，如 "这是什么"
4. 等待AI分析和TTS播报

**预期输出**:
```
👂 [唤醒] 进入语音唤醒模式，唤醒词: 你好小智
🎧 [唤醒] 第 1 次监听...
✓ 麦克风I2S驱动已初始化(新API)
🎤 开始录音 2 秒...
✓ 录音完成
🗣️ [唤醒] 识别内容: 你好小智
✅ [唤醒] 检测到唤醒词！
[播放提示音]
🎯 [唤醒] 唤醒成功，请在提示音后说出指令...
🎤 开始录音 5 秒...
💡 生成提示词基于语音: 这是什么
📸 拍照完成
🤖 调用视觉AI...
🔊 [TTS] 播放分析结果
```

**判断标准**:
- ✅ **通过**: 完整流程顺利执行
- ✅ **通过**: 唤醒词识别准确
- ✅ **通过**: 指令识别准确
- ✅ **通过**: AI分析结果符合预期
- ❌ **失败**: 任何环节出错或卡死

---

## 🔍 故障排查

### 问题A: 录音字节数为0

**可能原因**:
1. 麦克风未正确连接
2. I2S引脚配置错误
3. 麦克风供电不足

**排查步骤**:
```cpp
// 检查引脚定义 (AI_Answer.ino 约199-202行)
#define MIC_I2S_BCLK_PIN    47
#define MIC_I2S_LRC_PIN     45
#define MIC_I2S_DIN_PIN     48
```

**解决方案**:
- 用万用表测试麦克风VDD是否为3.3V
- 检查接线是否松动
- 更换麦克风模块测试

---

### 问题B: 语音识别结果为空

**可能原因**:
1. 录音音量太小
2. 麦克风灵敏度不够
3. 环境噪音过大
4. ASR API配置错误

**排查步骤**:
1. 检查录音字节数是否正常
2. 贴近麦克风大声说话测试
3. 检查百度ASR API Key是否正确
4. 查看ASR响应错误码

**解决方案**:
```cpp
// 增加录音时长
#define VOICE_COMMAND_SECONDS 8  // 从5秒改为8秒

// 检查API配置
Serial.println(BAIDU_ASR_API_KEY);  // 确认不为空
```

---

### 问题C: TTS播放无声音

**可能原因**:
1. 扬声器接线错误
2. 增益设置不对
3. I2S引脚配置错误
4. 扬声器供电不足

**排查步骤**:
```cpp
// 检查引脚定义 (AI_Answer.ino 约179行)
#define I2S_NUM I2S_NUM_0
#define I2S_BCLK_PIN    21
#define I2S_LRC_PIN     42
#define I2S_DOUT_PIN    41
```

**解决方案**:
- 用万用表测试扬声器VIN是否为5V
- 确认GAIN引脚连接正确
- 测试扬声器是否损坏

---

### 问题D: 系统重启或I2S冲突

**可能原因**:
1. 代码未完全更新
2. ENABLE_MICROPHONE设置错误
3. 仍在使用旧版I2S API

**排查步骤**:
```bash
# 检查头文件
grep "driver/i2s.h" AI_Answer.ino
# 应该只在条件编译中出现,且已替换为 driver/i2s_std.h

# 检查麦克风启用标志
grep "ENABLE_MICROPHONE" AI_Answer.ino
# 应该显示 #define ENABLE_MICROPHONE 1
```

**解决方案**:
- 完全重新下载最新代码
- 清除Arduino IDE缓存
- 重新编译上传

---

## 📊 性能基准

**正常工作参数:**

| 项目 | 数值 | 说明 |
|------|------|------|
| 录音时长 | 5秒 | 可调整 |
| 录音数据量 | 160000字节 | 16000Hz * 2字节 * 5秒 |
| 麦克风初始化时间 | 50-100ms | 新API |
| 录音超时 | 6.5秒 | 5秒 * 1.3倍余量 |
| TTS播放延迟 | <1秒 | 网络+缓冲 |
| 语音识别响应时间 | 2-5秒 | 取决于网络 |

---

## ✅ 测试通过标准

**最低要求:**
- ✅ 测试1-5 全部通过
- ✅ 无系统重启
- ✅ 无I2S冲突错误

**完美状态:**
- ✅ 测试1-6 全部通过
- ✅ 语音识别准确率 >80%
- ✅ TTS播放清晰无杂音
- ✅ 连续运行30分钟无异常

---

## 📝 测试记录模板

```
测试日期: ____________________
测试人员: ____________________
硬件版本: ESP32-S3 CAM
固件版本: 2025-11-09

测试结果:
[ ] 测试1: 系统启动 - 通过/失败
[ ] 测试2: 麦克风录音 - 通过/失败
[ ] 测试3: 语音识别 - 通过/失败
[ ] 测试4: TTS播放 - 通过/失败
[ ] 测试5: 交替使用 - 通过/失败
[ ] 测试6: 语音唤醒 - 通过/失败

问题记录:
_________________________________
_________________________________

备注:
_________________________________
```

---

**祝测试顺利！** 🎉

如遇到问题，请参考 [GPIO_CONFLICT_FIX.md](GPIO_CONFLICT_FIX.md) 的故障排查部分。
